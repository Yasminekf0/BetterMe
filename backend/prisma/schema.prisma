// Prisma Schema for Master Trainer
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// User model - 用户基础模型
model User {
  id                 String          @id @default(uuid())
  email              String?         @unique
  password           String?
  name               String
  avatar             String?
  phone              String?         @unique
  role               UserRole        @default(USER)
  department         String?
  isActive           Boolean         @default(true)
  // 多语言偏好
  language           String          @default("en")
  // 会员相关
  membershipId       String?
  membership         MembershipPlan? @relation(fields: [membershipId], references: [id])
  membershipExpireAt DateTime?
  // 积分
  points             Int             @default(0)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  // Relations
  sessions         Session[]
  scenarios        Scenario[]             @relation("CreatedScenarios")
  emails           FollowUpEmail[]
  personaTemplates BuyerPersonaTemplate[] @relation("CreatedPersonas")
  operationLogs    OperationLog[]         @relation("UserOperations")
  oauthAccounts    OAuthAccount[]
  orders           Order[]
  pointRecords     PointRecord[]
  notifications    UserNotification[]
  articles         Article[]              @relation("ArticleAuthor")
  media            Media[]                @relation("MediaUploader")
  roleAssignments  UserRoleAssignment[]
  conversations    Conversation[]         @relation("UserConversations")

  @@map("users")
}

enum UserRole {
  USER
  TRAINER
  ADMIN
  SUPER_ADMIN
}

// OAuth Account - 第三方登录账户
model OAuthAccount {
  id            String        @id @default(uuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider      OAuthProvider
  providerId    String // 第三方平台用户ID
  accessToken   String?       @db.Text
  refreshToken  String?       @db.Text
  tokenExpireAt DateTime?
  profile       Json? // 存储第三方返回的用户信息
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([provider, providerId])
  @@map("oauth_accounts")
}

enum OAuthProvider {
  WECHAT
  DINGTALK
  FEISHU
  GOOGLE
  GITHUB
}

// Login Config - 登录方式配置
model LoginConfig {
  id          String        @id @default(uuid())
  provider    OAuthProvider
  name        String
  isEnabled   Boolean       @default(false)
  appId       String?
  appSecret   String?
  redirectUri String?
  scope       String?
  config      Json? // 额外配置
  sortOrder   Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([provider])
  @@map("login_configs")
}

// Scenario model
model Scenario {
  id                String     @id @default(uuid())
  title             String
  description       String     @db.Text
  category          String
  difficulty        Difficulty @default(MEDIUM)
  estimatedDuration Int        @default(15)
  isActive          Boolean    @default(true)
  practiceCount     Int        @default(0)
  averageScore      Float      @default(0)

  // Buyer Persona (stored as JSON)
  buyerPersona Json

  // Objections and ideal responses
  objections     Json
  idealResponses Json

  // AI Configuration
  maxTurns       Int     @default(8)
  scoringWeights Json?
  openingPrompt  String? @db.Text

  createdById String
  createdBy   User     @relation("CreatedScenarios", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  sessions Session[]

  @@map("scenarios")
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

// Session model (practice session)
model Session {
  id          String        @id @default(uuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id])
  scenarioId  String
  scenario    Scenario      @relation(fields: [scenarioId], references: [id])
  status      SessionStatus @default(ACTIVE)
  startedAt   DateTime      @default(now())
  completedAt DateTime?

  // RelationsAPI
  messages     Message[]
  feedback     Feedback?
  email        FollowUpEmail?
  // This is the "Back-Reference". 
  // It does NOT create a column in MySQL. 
  // It only tells Prisma that a JOIN is possible.
  conversations Conversation[]

  @@map("sessions")
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

// Message model
model Message {
  id             String        @id @default(uuid())
  sessionId      String
  session        Session       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  conversationId String? // Link to conversation for easier querying
  conversation   Conversation? @relation("ConversationMessages", fields: [conversationId], references: [id], onDelete: Cascade)
  role           MessageRole
  content        String        @db.Text
  timestamp      DateTime      @default(now())

  // Message metadata
  embeddings Json? // Store vector embeddings for semantic search (optional)

  @@index([sessionId])
  @@index([conversationId])
  @@index([timestamp])
  @@map("messages")
}

enum MessageRole {
  USER
  AI
  SYSTEM
}

// Conversation model - High-level abstraction for recording and managing chat histories
model Conversation {
  id         String  @id @default(uuid())
  sessionId  String
  session    Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId     String
  user       User    @relation("UserConversations", fields: [userId], references: [id], onDelete: Cascade)
  scenarioId String

  // Conversation metadata
  title     String? // Optional title for the conversation
  summary   String? @db.Text // AI-generated or user-provided summary
  keyTopics Json? // Array of key topics discussed
  tags      Json? // Array of custom tags for categorization

  // Conversation statistics
  messageCount     Int    @default(0) // Total messages (user + AI)
  userMessageCount Int    @default(0) // User messages only
  aiMessageCount   Int    @default(0) // AI messages only
  averageSentiment Float? // -1 to 1, sentiment analysis of user messages

  // Conversation state
  isArchived  Boolean @default(false) // For archiving old conversations
  isPinned    Boolean @default(false) // For pinning important conversations
  isFavorited Boolean @default(false) // User can mark as favorite

  // Timestamps
  startedAt     DateTime  @default(now())
  completedAt   DateTime? // When conversation ended
  lastMessageAt DateTime  @default(now()) @updatedAt // For sorting by recency
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  recordingUrl String? // Quick access to the audio link
  mediaId      String? // Relation to the formal Media table
  media        Media?  @relation(fields: [mediaId], references: [id])

  // Relations
  messages Message[] @relation("ConversationMessages")

  // Indexes for common queries
  @@index([userId])
  @@index([sessionId])
  @@index([scenarioId])
  @@index([isArchived])
  @@index([isFavorited])
  @@index([lastMessageAt]) // For sorting by recent
  @@index([createdAt]) // For sorting by creation time
  @@map("conversations")
}

// Feedback model
model Feedback {
  id              String   @id @default(uuid())
  sessionId       String   @unique
  session         Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  overallScore    Int
  dimensions      Json // Array of FeedbackDimension
  summary         String   @db.Text
  recommendations Json
  createdAt       DateTime @default(now())

  @@map("feedbacks")
}

// Follow-up Email model
model FollowUpEmail {
  id        String   @id @default(uuid())
  sessionId String   @unique
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  toAddress String?
  subject   String
  body      String   @db.Text
  isEdited  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("follow_up_emails")
}

// AI Model Category Enum - AI模型分类枚举
// Different categories have different API endpoints / 不同分类有不同的API端点
enum AIModelCategory {
  CHAT          // Text chat/conversation models / 文本对话模型
  TTS           // Text-to-Speech models / 语音合成模型
  STT           // Speech-to-Text models (ASR) / 语音转文字模型
  EMBEDDING     // Vector/Embedding models / 向量嵌入模型
  MULTIMODAL    // Multimodal models (vision, etc.) / 多模态模型
}

// AI Model Configuration
// AI模型配置 - 支持多个AI提供商（阿里云百炼等）
// API Doc: https://help.aliyun.com/zh/model-studio/
model AIModel {
  id          String           @id @default(uuid())
  modelId     String           @unique
  name        String
  provider    String
  // Model category - determines API endpoint type / 模型分类 - 决定API端点类型
  category    AIModelCategory  @default(CHAT)
  description String?
  // API Endpoint - API接口地址 (different for each category / 每个分类不同)
  // e.g., Chat: https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions
  // e.g., TTS: https://dashscope.aliyuncs.com/compatible
  // e.g., Embedding: https://dashscope.aliyuncs.com/compatible-mode/v1
  // e.g., STT: wss://dashscope.aliyuncs.com/api-ws/v1/realtime
  apiEndpoint String?
  // API Key - API密钥 (encrypted storage recommended / 建议加密存储)
  apiKey      String?          @db.Text
  isDefault   Boolean          @default(false)
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  config      Json? // Additional configuration
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@map("ai_models")
}

// System Settings
model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// Buyer Persona Template - Reusable buyer persona library
model BuyerPersonaTemplate {
  id          String   @id @default(uuid())
  name        String
  role        String // e.g., 'CTO', 'Compliance Director'
  company     String
  background  String   @db.Text
  concerns    Json
  personality String
  category    String // e.g., 'Technical', 'Business', 'Procurement'
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdById String?
  createdBy   User?    @relation("CreatedPersonas", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("buyer_persona_templates")
}

// Operation Log - Audit trail for admin actions
model OperationLog {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation("UserOperations", fields: [userId], references: [id])
  operationType String // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  targetType    String // USER, SCENARIO, SETTING, etc.
  targetId      String?
  description   String   @db.Text
  details       Json? // Additional operation details
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([operationType])
  @@index([targetType])
  @@index([createdAt])
  @@map("operation_logs")
}

// ==================== 媒体管理 Media Management ====================

// Media - 媒体文件
model Media {
  id            String         @id @default(uuid())
  name          String // 文件名
  originalName  String // 原始文件名
  path          String // 文件路径
  url           String // 访问URL
  mimeType      String // MIME类型
  size          Int // 文件大小(bytes)
  width         Int? // 图片宽度
  height        Int? // 图片高度
  storageType   StorageType    @default(LOCAL)
  bucket        String? // 存储桶名称
  uploadedById  String
  uploadedBy    User           @relation("MediaUploader", fields: [uploadedById], references: [id])
  conversations Conversation[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([uploadedById])
  @@index([mimeType])
  @@map("media")
}

enum StorageType {
  LOCAL
  ALIYUN_OSS
  AWS_S3
}

// Storage Config - 存储配置
model StorageConfig {
  id                 String      @id @default(uuid())
  type               StorageType @unique
  name               String
  isEnabled          Boolean     @default(false)
  isDefault          Boolean     @default(false)
  // 阿里云OSS配置
  accessKeyId        String?
  accessKeySecret    String?
  endpoint           String?
  bucket             String?
  region             String?
  // AWS S3配置
  awsAccessKeyId     String?
  awsSecretAccessKey String?
  awsRegion          String?
  awsBucket          String?
  // 通用配置
  baseUrl            String? // CDN或访问域名
  maxFileSize        Int         @default(10485760) // 默认10MB
  allowedMimeTypes   Json // 允许的文件类型
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  @@map("storage_configs")
}

// ==================== 插件市场 Plugin Marketplace ====================

// Plugin - 插件
model Plugin {
  id            String         @id @default(uuid())
  slug          String         @unique // 唯一标识符
  name          String
  description   String?        @db.Text
  icon          String?
  version       String         @default("1.0.0")
  author        String?
  category      PluginCategory
  price         Float          @default(0) // 0表示免费
  downloadCount Int            @default(0)
  rating        Float          @default(0)
  isActive      Boolean        @default(true)
  isFeatured    Boolean        @default(false)
  config        Json? // 插件配置模板
  permissions   Json // 所需权限
  dependencies  Json // 依赖其他插件
  changelog     Json? // 版本更新日志
  screenshots   Json // 截图URL
  documentation String?        @db.Text
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  installations PluginInstallation[]

  @@map("plugins")
}

enum PluginCategory {
  AI_TOOLS // AI工具
  ANALYTICS // 数据分析
  COMMUNICATION // 沟通工具
  PRODUCTIVITY // 效率工具
  INTEGRATION // 集成
  MARKETING // 营销
  CONTENT // 内容
  OTHER // 其他
}

// Plugin Installation - 用户安装的插件
model PluginInstallation {
  id          String   @id @default(uuid())
  pluginId    String
  plugin      Plugin   @relation(fields: [pluginId], references: [id], onDelete: Cascade)
  isEnabled   Boolean  @default(true)
  config      Json? // 用户自定义配置
  installedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([pluginId])
  @@map("plugin_installations")
}

// ==================== 文章管理 Article Management ====================

// Article Category - 文章分类
model ArticleCategory {
  id          String            @id @default(uuid())
  name        String
  slug        String            @unique
  description String?
  parentId    String?
  parent      ArticleCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ArticleCategory[] @relation("CategoryHierarchy")
  sortOrder   Int               @default(0)
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  articles Article[]

  @@map("article_categories")
}

// Article - 文章
model Article {
  id             String           @id @default(uuid())
  title          String
  slug           String           @unique
  content        String           @db.Text
  excerpt        String?          @db.Text
  coverImage     String?
  categoryId     String?
  category       ArticleCategory? @relation(fields: [categoryId], references: [id])
  authorId       String
  author         User             @relation("ArticleAuthor", fields: [authorId], references: [id])
  status         ArticleStatus    @default(DRAFT)
  viewCount      Int              @default(0)
  tags           Json
  seoTitle       String?
  seoDescription String?
  publishedAt    DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([categoryId])
  @@index([authorId])
  @@index([status])
  @@map("articles")
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// ==================== 通知管理 Notification Management ====================

// Notification - 通知模板
model Notification {
  id          String             @id @default(uuid())
  title       String
  content     String             @db.Text
  type        NotificationType
  targetType  NotificationTarget
  targetIds   Json // 目标用户ID列表,空表示全部
  isRead      Boolean            @default(false)
  sendAt      DateTime? // 定时发送时间
  sentAt      DateTime? // 实际发送时间
  createdById String?
  metadata    Json? // 额外数据
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  userNotifications UserNotification[]

  @@map("notifications")
}

enum NotificationType {
  SYSTEM // 系统通知
  ANNOUNCEMENT // 公告
  PROMOTION // 推广
  REMINDER // 提醒
  UPDATE // 更新
}

enum NotificationTarget {
  ALL // 所有用户
  SPECIFIC // 指定用户
  ROLE // 按角色
}

// User Notification - 用户通知关联
model UserNotification {
  id             String       @id @default(uuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())

  @@unique([userId, notificationId])
  @@map("user_notifications")
}

// ==================== 支付配置 Payment Configuration ====================

// Payment Config - 支付配置
model PaymentConfig {
  id                  String          @id @default(uuid())
  provider            PaymentProvider @unique
  name                String
  isEnabled           Boolean         @default(false)
  isSandbox           Boolean         @default(false) // 是否测试模式
  // 微信支付
  wechatAppId         String?
  wechatMchId         String?
  wechatApiKey        String?
  wechatCertPath      String?
  // 支付宝
  alipayAppId         String?
  alipayPrivateKey    String?         @db.Text
  alipayPublicKey     String?         @db.Text
  // PayPal
  paypalClientId      String?
  paypalSecret        String?
  // Stripe
  stripePublicKey     String?
  stripeSecretKey     String?
  stripeWebhookSecret String?
  // 易支付
  epayUrl             String?
  epayPid             String?
  epayKey             String?
  // 通用配置
  notifyUrl           String?
  returnUrl           String?
  sortOrder           Int             @default(0)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@map("payment_configs")
}

enum PaymentProvider {
  WECHAT // 微信支付
  ALIPAY // 支付宝
  PAYPAL // PayPal
  STRIPE // Stripe
  EPAY // 易支付
}

// ==================== 订单管理 Order Management ====================

// Order - 订单
model Order {
  id            String           @id @default(uuid())
  orderNo       String           @unique
  userId        String
  user          User             @relation(fields: [userId], references: [id])
  orderType     OrderType
  status        OrderStatus      @default(PENDING)
  amount        Float
  currency      String           @default("USD")
  paymentMethod PaymentProvider?
  transactionId String? // 支付平台交易号
  productId     String? // 商品ID(会员套餐ID等)
  productName   String // 商品名称
  productDesc   String? // 商品描述
  metadata      Json? // 订单额外信息
  paidAt        DateTime?
  refundedAt    DateTime?
  expiredAt     DateTime? // 订单过期时间
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([userId])
  @@index([orderNo])
  @@index([status])
  @@map("orders")
}

enum OrderType {
  MEMBERSHIP // 会员套餐
  POINTS // 积分购买
  PLUGIN // 插件购买
  OTHER // 其他
}

enum OrderStatus {
  PENDING // 待支付
  PAID // 已支付
  COMPLETED // 已完成
  CANCELLED // 已取消
  REFUNDED // 已退款
  EXPIRED // 已过期
}

// ==================== 会员套餐 Membership Plans ====================

// Membership Plan - 会员套餐
model MembershipPlan {
  id            String   @id @default(uuid())
  name          String
  slug          String   @unique
  description   String?  @db.Text
  price         Float
  originalPrice Float? // 原价(用于显示折扣)
  currency      String   @default("USD")
  duration      Int // 天数
  features      Json // 功能列表
  limits        Json? // 使用限制(如AI对话次数等)
  isActive      Boolean  @default(true)
  isFeatured    Boolean  @default(false)
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  users User[]

  @@map("membership_plans")
}

// ==================== 积分系统 Points System ====================

// Points Config - 积分配置
model PointsConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  description String?
  points      Int // 积分值(正为获得,负为消耗)
  isEnabled   Boolean  @default(true)
  dailyLimit  Int? // 每日限制次数
  totalLimit  Int? // 总限制次数
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("points_configs")
}

// Point Record - 积分记录
model PointRecord {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  points      Int // 变动积分
  balance     Int // 变动后余额
  type        PointType
  description String
  relatedId   String? // 关联ID(订单ID等)
  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([type])
  @@map("point_records")
}

enum PointType {
  EARN // 获得
  SPEND // 消费
  REFUND // 退还
  ADJUST // 调整
  EXPIRE // 过期
}

// ==================== 角色权限管理 Role Permission Management ====================

// Role - 角色
model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String
  description String?
  isSystem    Boolean  @default(false) // 系统内置角色
  permissions Json // 权限列表
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userAssignments UserRoleAssignment[]

  @@map("roles")
}

// User Role Assignment - 用户角色分配
model UserRoleAssignment {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, roleId])
  @@map("user_role_assignments")
}

// Permission - 权限定义(用于前端展示)
model Permission {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  description String?
  module      String // 模块
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("permissions")
}

// ==================== 多语言设置 Multi-Language Settings ====================

// Language - 支持的语言
model Language {
  id         String   @id @default(uuid())
  code       String   @unique // 语言代码 en, zh-CN, etc.
  name       String // 语言名称
  nativeName String // 本地名称
  isEnabled  Boolean  @default(true)
  isDefault  Boolean  @default(false)
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  translations Translation[]

  @@map("languages")
}

// Translation - 翻译
model Translation {
  id         String   @id @default(uuid())
  languageId String
  language   Language @relation(fields: [languageId], references: [id], onDelete: Cascade)
  key        String // 翻译键
  value      String   @db.Text // 翻译值
  namespace  String   @default("common") // 命名空间
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([languageId, key, namespace])
  @@index([key])
  @@map("translations")
}

// ==================== RAG Document Management / RAG文档管理 ====================

// RAG Document Status - RAG文档状态
enum RAGDocumentStatus {
  PENDING       // 待处理
  PROCESSING    // 处理中
  COMPLETED     // 已完成
  FAILED        // 失败
}

// RAG Document - RAG文档
// Stores uploaded documents for RAG / 存储用于RAG的上传文档
model RAGDocument {
  id              String            @id @default(uuid())
  name            String            // Display name / 显示名称
  originalName    String            // Original file name / 原始文件名
  fileType        String            // File extension / 文件扩展名
  filePath        String            // Storage path / 存储路径
  fileSize        Int               // File size in bytes / 文件大小（字节）
  mimeType        String?           // MIME type / MIME类型
  // Processing info / 处理信息
  status          RAGDocumentStatus @default(PENDING)
  chunkCount      Int               @default(0)      // Number of chunks / 块数量
  chunkSize       Int               @default(500)    // Chunk size setting / 块大小设置
  chunkOverlap    Int               @default(50)     // Chunk overlap setting / 块重叠设置
  vectorCount     Int               @default(0)      // Successfully vectorized count / 成功向量化数量
  errorMessage    String?           @db.Text         // Error message if failed / 失败时的错误信息
  processedAt     DateTime?         // Processing completion time / 处理完成时间
  // Metadata / 元数据
  description     String?           @db.Text         // Document description / 文档描述
  tags            Json?             // Tags for categorization / 分类标签
  collectionName  String            @default("bettermeCollection") // Vector collection name / 向量集合名称
  // Audit fields / 审计字段
  uploadedById    String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations / 关联
  chunks          RAGChunk[]

  @@index([status])
  @@index([fileType])
  @@index([uploadedById])
  @@map("rag_documents")
}

// RAG Chunk - 文档向量块（本地存储）
// Used when DashVector is not configured / 当DashVector未配置时使用
model RAGChunk {
  id              String            @id @default(uuid())
  documentId      String            // Parent document ID / 父文档ID
  document        RAGDocument       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  chunkIndex      Int               // Chunk sequence number / 块序号
  text            String            @db.Text          // Chunk text content / 块文本内容
  embedding       Json?             // Vector embedding (stored as JSON array) / 向量嵌入（存储为JSON数组）
  startOffset     Int               // Start position in original text / 原文本起始位置
  endOffset       Int               // End position in original text / 原文本结束位置
  metadata        Json?             // Additional metadata / 附加元数据
  createdAt       DateTime          @default(now())

  @@unique([documentId, chunkIndex])
  @@index([documentId])
  @@map("rag_chunks")
}

